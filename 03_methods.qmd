# Methodology {#sec-methods}

```{r setup, file = "R/chapter_start.R", include = FALSE}
# a number of commands need to run at the beginning of each chapter. This
# includes loading libraries that I always use, as well as options for 
# displaying numbers and text.
```

```{r setup2, include = FALSE}
# Other packages ------
# These are packages that get used in this chapter but aren't part of the default set.

library(ggplot2)
library(RColorBrewer)
library(kableExtra)
library(dplyr)
library(tidyr)
library(targets)
library(ggpattern)
library(extrafont)
library(scales)
```

As highlighted in the [Literature Review](#sec-literature), there is substantial evidence indicating that IMT can effectively reduce RCT and ECU following traffic incidents. Additionally, the effectiveness of DTA models in analyzing the impact of such incidents has been well-documented. However, there is a lack of comprehensive research evaluating IMT impact on entire traffic networks and their associated agents. To address this gap, it is necessary that we develop a model  capable of simulating both traffic incidents and the ensuing IMT interventions, with the objective of gauging the efficiency of IMT deployments. Due to its proficiency in regional-scale incident simulation and its authentic portrayal of driver behavior, MATSim has been identified as the most suitable model for this research. This section describes the methodology, expounding on the model’s capabilities, the requisite data inputs, and the benchmarks established for determining IMT efficacy.

Our methodology is structured around three main components: the functionality of the MATSim model, the setup of IMT vehicles and incidents, and the scenarios for comparative analysis. In the [Model Design in MATSim](#sec-MATSim_mod) we describe the structure of the model and the functions it uses to represent incidents and IMT response. In [Model Implementaiton](#sec-model_imp) we outline the structure of the simulation by first describing [IMT Setup](#sec-IMT_setup), then [Incident Data and Sampling](#sec-inc_data) and conclude by describing the [Scenarios](#sec-scenarios) used for evaluating the impact of incidents and IMT.

## Model Design in MATSim {#sec-MATSim_mod}

MATSim is an open-source framework used for conducting extensive, agent-based transportation simulations on a large scale. Operating as a dynamic traffic simulation, it plays crucial roles in demand modeling and agent-based mobility analysis [@dobler2016]. Thanks to its open-source architecture, MATSim enables the seamless integration of a diverse array of modules and packages into its models. Users across the platform can create, import, and modify these components, fostering a collaborative and innovative environment.

For the purposes of our research, we developed the ImtModule, a specialized MATSim extension designed to process incidents and IMT responses within the simulation. This module leverages existing research on incident simulation, Demand Rapid Transit (DRT), event handling, and vehicle dispatch algorithms, building upon these foundations to enhance the functionality of our model.

In this section, we describe some of the specific tools within MATSim that we used and adapted to construct a comprehensive and functional model for both processing and analysis. These tools include Network Change Events, Vehicle Assignment, and Incident Response. Together, they contribute to the realism and precision of our traffic simulations, particularly in the context of responding to roadway incidents, ensuring that our model provides accurate and reliable results.

### Replanning and Scoring {#sec-MATSim_Score}

\<\< I need to read up in the MATSim textbook and look at our model a little bit more to write this section well. I'll get to it once I'm done editing the rest of this section \>\>

### Network Change Events {#sec-NCE}

Within a MATSim network, each link is characterized by specific attributes such as type, length, number of lanes, free-flow speed, and capacity. To effectively simulate unexpected events and their subsequent impacts on traffic flow, it is essential to dynamically adjust these attributes. This capability, termed a Time-Dependent Network, is elaborated upon in the MATSim textbook [@rieser2016] and is vital for ensuring the realism and accuracy of our simulation.

Network Change Events (NCE) serve as the mechanism within MATSim for modifying network attributes at precise moments during a simulation. Detailed in Section 6.1 of the MATSim textbook [@rieser2016], the implementation of NCE requires specific adjustments to the MATSim configuration file to facilitate a time-variant network. These events can modify a link's free-flow speed, number of lanes, or capacity. To initiate a network change event, the system requires specific information including the time of the event `startTime`, the affected link(s) `link refID`, the type of change `free-flow speed`, `lanes`, or `capacity`, and the value of the change. NCE are the tools used in this study to demonstrate the impact of both incidents and IMT arrivals.

### IMT Assignment and Response {#sec-imt_response}

Within MATSim, the dispatch of one or more IMT is prompted by the occurrence of an incident. The optimal IMT for the situation is determined using a least-cost path dispatch algorithm, which bases its calculations on vehicle paths while considering factors such as congestion and link speed. The success of these methods heavily relies on the IMT units' capability to navigate through traffic. In cases where all IMT units are occupied at the time of an incident, the algorithm waits until a unit becomes available, and subsequently dispatches it to the incident site.

Upon an IMT's arrival at an incident site, a NCE is activated via an event handler, a MATSim tool that functions to log simulation events in real-time. While incidents reduce a link's capacity, the IMT's arrival triggers a NCE that restores 25% of the capacity gap on the affected link. The capacity gap is defined as the difference between the link’s full capacity and its reduced capacity during an incident. In situations requiring the response of multiple IMT, each arriving unit restores an additional 25% of the existing capacity gap.

@fig-imt_capacity_restore demonstrates the potential impact of an incident lacking IMT intervention, compared with scenarios that include the response of one or two IMT units. This illustration highlights the critical role of IMTs, showcasing their ability to mitigate incident impacts on network traffic flow.

```{r incident_capacity_restore}
#| label: fig-imt_capacity_restore
#| fig-cap: IMT capacity restoration upon arrival example.
# Load the capacity data points
tar_load(imt_capacity_data)

# Define the new color palette
color_palette <- brewer.pal(n = 3, name = "Set2")

# Create the plot
capacity_plot <- ggplot(imt_capacity_data, aes(x = time, y = capacity, 
                                               color = group, linetype = group)) +
  geom_line() +
  geom_point(size = 3) +
  labs(x = "Time (mins)", y = "Link Capacity Percent (%)") +
  scale_x_continuous(breaks = seq(0, 120, 30)) +
  scale_y_continuous(breaks = seq(0, 100, 25)) +
  scale_color_manual(values = color_palette) +
  scale_linetype_manual(values = c("No IMT Response" = "solid", 
                                   "First IMT Response" = "dashed", 
                                   "Second IMT Response" = "dashed")) +
  theme_minimal(base_family = "TeX Gyre Pagella", base_size = 11) +
  theme(legend.position = "top", legend.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed", "dashed"))))

capacity_plot
```

## Model Implementaiton {#sec-model_imp}

To run the MATSim model with the ImtModule extension a number of input resources are necessary. To function properly the model need the following:

- A plans file detailing the agents that will be modeled as well as their origins and destinations
- A network file with interconnected links by which the agents from within the plans file can travel
- A configurations file that outlines the scoring metrics of the simulation and establishes parameters pertaining to agent and IMT travel patterns
- An IMT file outlining the IMT starting locations and hours of operation
- An incidents file, containing the necessary data needed to effect NCE randomly throughout the simulation

The network and plans files used came from @lant2021 and @day2022 who developed and calibrated them as part of their research projects studying accessibility and ride-hailing throughout the Wasatch Front. The configurations file used in the model was based an adaptation of @kaddoura2018 of the file used by their MATSim incident analysis study. It was altered slightly to accommodate the IMT development but was largely left unaltered from the parameters they had set. The IMT file was produced with data provided by UDOT and UHP as outline in [IMT Setup](#sec-MATSim_mod). The incident data was produced by @hyer2023 in his research of IMT performance measures and is explain in [Incident Data and Sampling](#sec-inc_data) 

### IMT Setup {#sec-IMT_setup}

The Utah Department of Transportation currently operates a fleet of 20 IMT vehicles, distributed across three zones corresponding to the counties of Davis, Salt Lake, and Utah within the Wasatch Front. @fig-IMT_Map visually represents the boundaries of each county and the initial locations of both existing and newly proposed IMT vehicles used in out simulated scenarios.

![IMT starting locations example map.](figures/imt_gray_map.png){#fig-IMT_Map}

In this figure, circles represent existing vehicles, while stars denote proposed additions. These starting locations aim to ensure a balanced distribution across each county, based on shift types---either day or afternoon. While this arrangement does not replicate the real-world starting points of IMT truck drivers, who typically commence their shifts from their homes, it is a pragmatic approach. Given that the majority of their operations are concentrated along major interstates such as I-15, I-80, and I-215, and considering the daily variability in starting locations, positioning them along these primary routes is logical for our MATSim Scenario simulations. Notably, the "Increased-IMT" scenario incorporates all vehicles from the "Existing" fleet, supplemented by an additional 10 vehicles distributed across the three counties.

Our investigation primarily focuses on analyzing the potential impacts of augmenting the IMT fleet, rather than the influence of their starting locations. We hypothesize that an increase in vehicle numbers, assuming an equitable distribution, could enhance IMT effectiveness.

Additionally, vehicle scheduling is a critical aspect of our setup. All three counties operate IMT vehicles across day and afternoon shifts, with specific timeframes detailed in the trucks file for MATSim scenario runs. Although IMT vehicles typically do not cross county borders during operations, our MATSim network does not impose such constraints, allowing for vehicle movement across counties based on incident proximity. With these vehicle configurations established, we now turn our attention to the incident data the sampling used in establishing simulated scenarios.


### Incident Data and Sampling {#sec-inc_data}

@hyer2023 undertook concurrent IMT research and compiled a comprehensive dataset of incidents requiring IMT intervention, drawing on data from the UHP. He carefully ensured the completeness of each incident record in the dataset, capturing crucial details such as the incident start and end times, RCT, location, and extent of capacity reduction.

Analyzing data from 2018 and 2022, @hyer2023 successfully identified 411 unique incidents with varying degrees of severity, ranging from property damage to fatal incidents. We utilized this carefully curated dataset to selectively include specific incidents in the MATSim model. It is crucial to acknowledge that these 411 incidents only constitute a portion of all incidents reported by UHP during this time frame. A significant number of additional incidents were not considered in the analysis due to the absence of vital metrics necessary for a comprehensive evaluation (e.g., start time, RCT, etc.). Nevertheless, the integration of the 411 analyzed incidents with the additional incomplete records provides insights, aiding in the quantification of the total number of incidents within a specific time period. These combined incident records were used in modeling daily incident frequencies.

To generate ten distinct values representing daily incident frequencies, we employed a randomized sampling technique. These values were collectively termed Current Incident Frequencies as they were derived from the original distribution of daily incidents. Furthermore, we formulated a second set of ten daily incident values, named Increased Incident Frequencies. These values were extracted from the upper portion of the 2022 incident data and were specifically designed to assess the resilience and efficacy of the IMT system under scenarios of markedly increased daily incidents. The visual depiction of the original distribution of daily incidents, alongside the distributions for both the Current and Increased Incident Frequencies, is illustrated in @fig-incident_sampling_plot.


```{r incident_sampling_plot}
#| label: fig-incident_sampling_plot
#| fig-cap: Incident sampling distributions for current and increased incident frequencies.
# Load the incident sampling data
tar_load(incident_sampling_data)

# Define a new color palette
color_palette <- brewer.pal(n = 3, name = "Set2")

# Create the plot
incident_sampling_plot <- ggplot() +
  
  # Add bars for the 'Original Distribution' category
  geom_bar(data = subset(incident_sampling_data, category == "Original Distribution"), 
           aes(x = as.factor(Total_Count), fill = category), 
           position = "dodge", stat = "count", width = 0.8) +
  
  # Add bars for the 'Current Frequency' category
  geom_bar(data = subset(incident_sampling_data, category == "Current Frequency"), 
           aes(x = as.factor(Total_Count), fill = category), 
           position = "dodge", stat = "count", width = 0.8) +
  
  # Add bars for the 'Increased Frequency' category
  geom_bar(data = subset(incident_sampling_data, category == "Increased Frequency"), 
           aes(x = as.factor(Total_Count), fill = category), 
           position = "dodge", stat = "count", width = 0.8) +
  
  # Set the colors for the fill based on the defined color palette
  scale_fill_manual(values = setNames(color_palette, 
                                      c("Original Distribution", 
                                        "Current Frequency", 
                                        "Increased Frequency"))) +
  
  # Add labels for the x and y axes
  labs(x = 'Number of Incidents in a Given Day', y = 'Frequency') +
  
  # Use a minimal theme and set the base font family and size
  theme_minimal(base_family = "TeX Gyre Pagella", base_size = 11) +
  
  # Customize the appearance of the legend and text
  theme(legend.title = element_blank(),
        legend.position = c(0.95, 0.95),
        legend.justification = c("right", "top"),
        legend.margin = margin(-10, -10, -10, -10),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.key.size = unit(0.8, "cm"),
        text = element_text(size = 11)) +
  
  # Define the order of the x-axis categories
  scale_x_discrete(limits = levels(as.factor(incident_sampling_data$Total_Count)))

# Print the plot
incident_sampling_plot
```

In total, twenty values were selected, evenly split with ten allocated to the Current Incident Frequency category, and the remaining ten to the Increased Incident Frequency category. Each value was subsequently paired with a unique three-digit seed number, utilized internally within MATSim to ensure a randomized selection of incidents for each simulation scenario. Following this, we employed the MATSim  [Network Change Events](#sec-NCE) to integrate the incidents into the simulation.

### Scenarios {#sec-scenarios}

## IMT Vehicle Configuration and Incident Selection

The strategic placement and sizing of IMT fleets are pivotal in optimizing vehicle response times, a relationship explored in depth by @lou2011 and @pal2002. Furthermore, @schultz2019 established a significant link between response time (RT) and roadway clearance time (RCT). In the 'IMT Vehicle Setup' subsection, we describe the organization of the IMT vehicle, taking these relationships into account and adhering to recommendations from Utah Highway Patrol officials specific to this project.

Additionally, the nature and severity of incidents play a significant role in affecting average travel times and delays, as evidenced by the research of @kaddoura2018. The 'Incident Data' and 'Incident Sampling' subsections elaborate on our methodology for selecting incidents for the simulation scenarios, utilizing data from concurrent research efforts.



## MATSim Functionality

In the MATSim model, factors such as incident selection are programmed within the model. The distribution and scheduling of trucks are described in XML truck files, which are then loaded into the model. As highlighted in the literature review, MATSim is an open-source platform that consists of various modules and packages. These components can be created, imported, and edited by users across the platform, fostering a collaborative environment.

For the purposes of our research, we developed the ImtModule, a specialized package designed to process incidents and IMT responses within the simulation. This module leverages existing research on incident simulation, Demand Rapid Transit (DRT), event handling, and vehicle dispatch algorithms, building upon these foundations to enhance the functionality of our model.

In this section, we delve into some of the specific tools within MATSim that we utilized and adapted to construct a comprehensive and functional model for both processing and analysis. These tools include Network Change Events, Vehicle Assignment, and Incident Response. Together, they contribute to the realism and precision of our traffic simulations, particularly in the context of responding to roadway incidents, ensuring that our model provides accurate and reliable results.

### Network Change Events


Network Change Events (NCEs) serve as the mechanism within MATSim for modifying network attributes at precise moments during a simulation. Detailed in Section 6.1 of the MATSim textbook, the implementation of NCEs necessitates specific adjustments to the MATSim configuration file to facilitate a time-variant network. These events can modify a link's free-flow speed, number of lanes, or capacity. To initiate a network change event, the system requires specific information including the time of the event (startTime), the affected link(s) (link refID), the type of change (free-flow speed, lanes, or capacity), and the value of the change.

Implementing network change events for incidents in our simulation is relatively straightforward. Each incident is specified with a start time, link ID, and capacity reduction factor. However, triggering network change events upon the arrival of an IMT vehicle is a more complex task. As outlined in the 'Vehicle Assignment' section, IMT vehicles are dispatched similarly to taxis or ambulances, building upon the existing framework of Demand Rapid Transit (DRT) described in the MATSim textbook. In line with their assignment algorithm, IMT vehicles receive a request and proceed to the location of the affected link. Their arrival times are variable and depend on the current traffic conditions.

To manage this uncertainty, we employ an 'event-handler', a tool that records the events of a simulation as it progresses. These events provide insights into when specific vehicles enter and exit links en route to their destinations. For IMT vehicles, event handlers were utilized to monitor their arrival at incident links, triggering specific network change events. In this study, every time an IMT vehicle reached an impacted link, it restored 25% of the link's lost capacity.

This approach ensures a dynamic and responsive simulation, reflecting the real-world scenarios where IMT vehicles play a crucial role in mitigating the impacts of roadway incidents. The implementation of the MATSim within-day replanning module further enhances this responsiveness, enabling the rerouting of other agents on the road in the aftermath of an incident.

Contrary to the work of @kaddoura2018, our study does not take into account long-term capacity reduction events such as road construction, focusing exclusively on short-term incidents like accidents or vehicle breakdowns. The reduced capacity of a specific link generally impacts all agents, both regular and IMT vehicles. However, if a subnetwork is employed, IMT trucks, akin to other emergency vehicles such as ambulances and firetrucks, experience less disruption from congestion caused by daily traffic or unexpected incidents.


## Scenario Simulations and Comparisons

Given the context regarding incident selection, IMT organization, and their collective impact on a network and its agents, a series of simulation scenarios were designed for a comprehensive comparative analysis. Each scenario was executed using a network and plans file previously utilized in research conducted by Dr. Macfarlane and research students at Brigham Young University for the Wasatch Front Regional Council (WFRC).

These network and plans files were integrated into our simulation scenarios, alongside the ImtModule described earlier, and other configuration parameters. The config parameters were primarily established by the configuration settings employed by @kaddoura2018 in their MATSim incident simulations. With all parameters set up and organized, a total of 60 simulation scenarios were executed to facilitate a thorough comparative analysis. The subsequent section provides a detailed outline of these scenarios and the methodology employed to compare and contrast their respective outcomes.

### Incident & IMT Scenario

This section outlines the methodology employed for selecting incidents in a set of 20 simulated "days." These simulations are categorized into two distinct groups: one reflecting the current distribution of incidents managed by the Utah Highway Patrol, and another representing a 10-day period with an elevated frequency of incidents, based on the upper range of daily incident data gathered in 2022.

Each of the 20 scenarios was assigned a unique random seed value, ensuring variability in incident selection across simulations. Subsequently, each group of scenarios was further divided into three distinct simulation conditions. The first condition, referred to as "Incidents-Only," includes only the incidents without any IMT intervention. The second condition incorporates the incidents along with the deployment of 20 IMT vehicles, while the third condition includes the incidents and an increased fleet of 30 IMT vehicles. For ease of organization and comparison, each scenario was assigned a unique code, such as "1-10-257." In this coding system, the first digit denotes the scenario type (Incidents-Only, 20 IMTs, or 30 IMTs), the second digit represents the number of incidents included in the simulation, and the third digit corresponds to the seed value used for random incident selection.

In total, six scenario groups were established, as outlined below:

-   No IMT, current incident frequency
-   No IMT, increased incident frequency
-   20 IMT, current incident frequency
-   20 IMT, increased incident frequency
-   30 IMT, current incident frequency
-   30 IMT, increased incident frequency

It is important to note, as described in the IMT Vehicle Setup section, that not all IMT vehicles are operational simultaneously. Due to scheduling constraints, the actual number of vehicles on the road at any given time is typically approximately half of the total fleet size.

### Comparative Measures

The study employed the MATSim model for simulations across three scenarios: 'Incidents', '20-Truck', and '30-Truck'. Each scenario was compared internally, as well as against a 'Baseline' scenario without incidents or IMT intervention. This multi-level comparison provides an overall view of the IMTs' influence on traffic flow and their operational efficiency.

The primary metric for traffic impact analysis in this study is the total vehicle hours of delay (VHD), dissected through three investigative tiers: Network Links, Motorway Links, and Impacted Links. 'Network Links' offer a macroscopic view of the network-wide delay, 'Motorway Links' focus on major highways and freeways, and 'Impacted Links' provide a microscopic view of the delays at incident sites and their immediate upstream links. This tiered approach ensures a thorough analysis, capturing the overarching impact on traffic flow while also honing in on critical areas affected by incidents. The comparative analysis across different scenarios and tiers highlights the general impacts of IMTs and their efficacy, particularly at the 'Impact Link' level.

In addition to VHD, the study investigates the performance and operational efficiency of IMT vehicles. Metrics such as average travel times, distances, and incident response times of IMT trucks are compared across scenarios. The '20-Truck' scenario reflects the current fleet of IMT vehicles, while the '30-Truck' scenario introduces an additional 10 vehicles, providing a basis for comparison to discern the impact of fleet size on operational efficiency. The analysis encompasses both the time and distance traveled by IMT trucks to incidents, offering insights into how effectively these resources are deployed and utilized.

By comparing the performance metrics of IMT trucks across different scenarios, we gain a better understanding of how fleet size influences operational efficiency. This, in turn, informs strategic decisions regarding resource allocation and deployment, ensuring that IMT vehicles are optimally utilized to mitigate traffic delays and enhance roadway safety.
