# Methodology {#sec-methods}

```{r setup, file = "R/chapter_start.R", include = FALSE}
# a number of commands need to run at the beginning of each chapter. This
# includes loading libraries that I always use, as well as options for 
# displaying numbers and text.
```

```{r setup2, include = FALSE}
# Other packages ------
# These are packages that get used in this chapter but aren't part of the default set.

library(ggplot2)
library(RColorBrewer)
library(kableExtra)
library(dplyr)
library(tidyr)
library(targets)
library(ggpattern)
library(extrafont)
library(scales)
```

As highlighted in the [Literature Review](#sec-literature), there is substantial evidence indicating that IMT can effectively reduce RCT and ECU following traffic incidents. Additionally, the effectiveness of DTA models in analyzing the impact of such incidents has been well-documented. However, there is a lack of comprehensive research evaluating IMT impact on entire traffic networks and their associated agents. To address this gap, it is necessary that we develop a model  capable of simulating both traffic incidents and the ensuing IMT interventions, with the objective of gauging the efficiency of IMT deployments. Due to its proficiency in regional-scale incident simulation and its authentic portrayal of driver behavior, MATSim has been identified as the most suitable model for this research. This section describes the methodology, expounding on the model’s capabilities, the requisite data inputs, and the benchmarks established for determining IMT efficacy.

Our methodology is structured around three main components: the functionality of the MATSim model, the setup of IMT vehicles and incidents, and the scenarios for comparative analysis. In the [Model Design in MATSim](#sec-MATSim_mod) we describe the structure of the model and the functions it uses to represent incidents and IMT response. In [Model Implementaiton](#sec-model_imp) we outline the structure of the simulation by first describing [IMT Setup](#sec-IMT_setup), then [Incident Data and Sampling](#sec-inc_data) and conclude by describing the [Scenarios](#sec-scenarios) used for evaluating the impact of incidents and IMT.

## Model Design in MATSim {#sec-MATSim_mod}

MATSim is an open-source framework used for conducting extensive, agent-based transportation simulations on a large scale. Operating as a dynamic traffic simulation, it plays crucial roles in demand modeling and agent-based mobility analysis [@dobler2016]. Thanks to its open-source architecture, MATSim enables the seamless integration of a diverse array of modules and packages into its models. Users across the platform can create, import, and modify these components, fostering a collaborative and innovative environment.

For the purposes of our research, we developed the ImtModule, a specialized MATSim extension designed to process incidents and IMT responses within the simulation. This module leverages existing research on incident simulation, Demand Rapid Transit (DRT), event handling, and vehicle dispatch algorithms, building upon these foundations to enhance the functionality of our model.

In this section, we describe some of the specific tools within MATSim that we used and adapted to construct a comprehensive and functional model for both processing and analysis. These tools include Network Change Events, Vehicle Assignment, and Incident Response. Together, they contribute to the realism and precision of our traffic simulations, particularly in the context of responding to roadway incidents, ensuring that our model provides accurate and reliable results.

### Replanning and Scoring {#sec-MATSim_Score}

\<\< I need to read up in the MATSim textbook and look at our model a little bit more to write this section well. I'll get to it once I'm done editing the rest of this section \>\>

### Network Change Events {#sec-NCE}

Within a MATSim network, each link is characterized by specific attributes such as type, length, number of lanes, free-flow speed, and capacity. To effectively simulate unexpected events and their subsequent impacts on traffic flow, it is essential to dynamically adjust these attributes. This capability, termed a Time-Dependent Network, is elaborated upon in the MATSim textbook [@rieser2016] and is vital for ensuring the realism and accuracy of our simulation.

Network Change Events (NCE) serve as the mechanism within MATSim for modifying network attributes at precise moments during a simulation. Detailed in Section 6.1 of the MATSim textbook [@rieser2016], the implementation of NCE requires specific adjustments to the MATSim configuration file to facilitate a time-variant network. These events can modify a link's free-flow speed, number of lanes, or capacity. To initiate a network change event, the system requires specific information including the time of the event `startTime`, the affected link(s) `link refID`, the type of change `free-flow speed`, `lanes`, or `capacity`, and the value of the change. NCE are the tools used in this study to demonstrate the impact of both incidents and IMT arrivals.

### IMT Assignment and Response {#sec-imt_response}

Within MATSim, the dispatch of one or more IMT is prompted by the occurrence of an incident. The optimal IMT for the situation is determined using a least-cost path dispatch algorithm, which bases its calculations on vehicle paths while considering factors such as congestion and link speed. The success of these methods heavily relies on the IMT units' capability to navigate through traffic. In cases where all IMT units are occupied at the time of an incident, the algorithm waits until a unit becomes available, and subsequently dispatches it to the incident site.

Upon an IMT's arrival at an incident site, a NCE is activated via an event handler, a MATSim tool that functions to log simulation events in real-time. While incidents reduce a link's capacity, the IMT's arrival triggers a NCE that restores 25% of the capacity gap on the affected link. The capacity gap is defined as the difference between the link’s full capacity and its reduced capacity during an incident. In situations requiring the response of multiple IMT, each arriving unit restores an additional 25% of the existing capacity gap.

@fig-imt_capacity_restore demonstrates the potential impact of an incident lacking IMT intervention, compared with scenarios that include the response of one or two IMT units. This illustration highlights the critical role of IMTs, showcasing their ability to mitigate incident impacts on network traffic flow.

```{r incident_capacity_restore}
#| label: fig-imt_capacity_restore
#| fig-cap: IMT capacity restoration upon arrival example.
# Load the capacity data points
tar_load(imt_capacity_data)

# Define the new color palette
color_palette <- brewer.pal(n = 3, name = "Set2")

# Create the plot
capacity_plot <- ggplot(imt_capacity_data, aes(x = time, y = capacity, 
                                               color = group, linetype = group)) +
  geom_line() +
  geom_point(size = 3) +
  labs(x = "Time (mins)", y = "Link Capacity Percent (%)") +
  scale_x_continuous(breaks = seq(0, 120, 30)) +
  scale_y_continuous(breaks = seq(0, 100, 25)) +
  scale_color_manual(values = color_palette) +
  scale_linetype_manual(values = c("No IMT Response" = "solid", 
                                   "First IMT Response" = "dashed", 
                                   "Second IMT Response" = "dashed")) +
  theme_minimal(base_family = "TeX Gyre Pagella", base_size = 11) +
  theme(legend.position = "top", legend.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed", "dashed"))))

capacity_plot
```

## Model Implementaiton {#sec-model_imp}

To run the MATSim model with the ImtModule extension, a number of input resources are necessary. For the model to function properly, the following are needed:

  - A plans file detailing the agents to be modeled, as well as their origins and destinations.
  - A network file with interconnected links, enabling travel for the agents specified in the plans file.
  - A configuration file outlining the scoring metrics of the simulation and establishing parameters pertaining to agent and     IMT travel patterns.
  - An IMT file outlining the IMT starting locations and hours of operation.
  - An incidents file containing the necessary data to randomly effect NCE throughout the simulation.
  
The network and plans files used were developed and calibrated by @lant2021 and @day2022 as part of their research projects studying accessibility and ride-hailing throughout the Wasatch Front. The configuration file used in the model was adapted from the @kaddoura2018 file, which was used for their MATSim incident analysis study. It was slightly altered to accommodate the IMT development, but the parameters they set were largely left unaltered. The IMT file was produced using data provided by UDOT and UHP, as  outline in [IMT Setup](#sec-MATSim_mod). The incident data was produced by @hyer2023 in his research of IMT performance measures and is explain in [Incident Data and Sampling](#sec-inc_data). 

### IMT Setup {#sec-IMT_setup}

UDOT currently operates a fleet of 20 IMT, distributed across three zones corresponding to Davis, Salt Lake, and Utah counties within the Wasatch Front. @fig-IMT_Map provides a visual representation of the county boundaries and the initial locations of both existing and newly proposed IMT vehicles used in simulated scenarios.

![IMT starting locations example map.](figures/imt_gray_map.png){#fig-IMT_Map}

In @fig-IMT_Map, circles denote existing IMT vehicles, and stars represent proposed additions. These starting locations are strategically chosen to ensure a balanced distribution of IMT across each county. The specific locations are recorded in the IMT file as starting links, facilitating their integration into MATSim. Although @fig-IMT_Map illustrates the distribution of IMT during the evening shift, it’s important to note that the allocation of IMT remains consistent across the morning and afternoon shifts. Even with a 30-minute overlap between shifts, placing two IMT on the same link does not cause any operational issues. This setup, while not mirroring the real-world practice of IMT drivers starting their shifts from home, serves as a practical approach for our simulations. Given that a substantial portion of IMT operations occur along major interstates such as I-15, I-80, and I-215, and considering the daily variations in starting locations, this positioning along key routes is well-justified. In the 30-IMT scenario, all vehicles from the 20-IMT scenarios are included, supplemented by an additional 10 IMT, ensuring coverage across all three counties.

Our investigation primarily focuses on analyzing the potential impacts of increasing the IMT fleet, rather than on the influence of their starting locations. We hypothesize that an increase in the number of IMT, assuming uniform distribution, could enhance their effectiveness.

Additionally, vehicle scheduling is a critical aspect of our setup. All three counties operate IMT vehicles across day and afternoon shifts, with specific timeframes detailed in the truck file loaded into MATSim. Although IMT vehicles typically do not cross county borders during operations, our MATSim network does not impose such constraints, allowing for vehicle movement across counties based on incident proximity.

### Incident Data and Sampling {#sec-inc_data}

@hyer2023 undertook concurrent IMT research and compiled a comprehensive dataset of incidents requiring IMT intervention, drawing on data from the UHP. He carefully ensured the completeness of each incident record in the dataset, capturing crucial details such as the incident start and end times, RCT, location, and extent of capacity reduction.

Analyzing data from 2018 and 2022, @hyer2023 successfully identified 411 unique incidents with varying degrees of severity, ranging from property damage to fatal incidents. We utilized this carefully curated dataset to selectively include specific incidents in the MATSim model. It is crucial to acknowledge that these 411 incidents only constitute a portion of all incidents reported by UHP during this time frame. A significant number of additional incidents were not considered in the analysis due to the absence of vital metrics necessary for a comprehensive evaluation (e.g., start time, RCT, etc.). Nevertheless, the integration of the 411 analyzed incidents with the additional incomplete records provides insights, aiding in the quantification of the total number of incidents within a specific time period. These combined incident records were used in modeling daily incident frequencies.

To generate ten distinct values representing daily incident frequencies, we employed a randomized sampling technique. These values were collectively termed Current Incident Frequencies as they were derived from the original distribution of daily incidents. Furthermore, we formulated a second set of ten daily incident values, named Increased Incident Frequencies. These values were extracted from the upper portion of the 2022 incident data and were specifically designed to assess the resilience and efficacy of the IMT system under scenarios of markedly increased daily incidents. The visual depiction of the original distribution of daily incidents, alongside the distributions for both the Current and Increased Incident Frequencies, is illustrated in @fig-incident_sampling_plot.


```{r incident_sampling_plot}
#| label: fig-incident_sampling_plot
#| fig-cap: Incident sampling distributions for current and increased incident frequencies.
# Load the incident sampling data
tar_load(incident_sampling_data)

# Define a new color palette
color_palette <- brewer.pal(n = 3, name = "Set2")

# Create the plot
incident_sampling_plot <- ggplot() +
  
  # Add bars for the 'Original Distribution' category
  geom_bar(data = subset(incident_sampling_data, category == "Original Distribution"), 
           aes(x = as.factor(Total_Count), fill = category), 
           position = "dodge", stat = "count", width = 0.8) +
  
  # Add bars for the 'Current Frequency' category
  geom_bar(data = subset(incident_sampling_data, category == "Current Frequency"), 
           aes(x = as.factor(Total_Count), fill = category), 
           position = "dodge", stat = "count", width = 0.8) +
  
  # Add bars for the 'Increased Frequency' category
  geom_bar(data = subset(incident_sampling_data, category == "Increased Frequency"), 
           aes(x = as.factor(Total_Count), fill = category), 
           position = "dodge", stat = "count", width = 0.8) +
  
  # Set the colors for the fill based on the defined color palette
  scale_fill_manual(values = setNames(color_palette, 
                                      c("Original Distribution", 
                                        "Current Frequency", 
                                        "Increased Frequency"))) +
  
  # Add labels for the x and y axes
  labs(x = 'Number of Incidents in a Given Day', y = 'Frequency') +
  
  # Use a minimal theme and set the base font family and size
  theme_minimal(base_family = "TeX Gyre Pagella", base_size = 11) +
  
  # Customize the appearance of the legend and text
  theme(legend.title = element_blank(),
        legend.position = c(0.95, 0.95),
        legend.justification = c("right", "top"),
        legend.margin = margin(-10, -10, -10, -10),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.key.size = unit(0.8, "cm"),
        text = element_text(size = 11)) +
  
  # Define the order of the x-axis categories
  scale_x_discrete(limits = levels(as.factor(incident_sampling_data$Total_Count)))

# Print the plot
incident_sampling_plot
```

In total, twenty values were selected, evenly split with ten allocated to the Current Incident Frequency category, and the remaining ten to the Increased Incident Frequency category. Each value was subsequently paired with a unique three-digit seed number, utilized internally within MATSim to ensure a randomized selection of incidents for each simulation scenario. Following this, we employed the MATSim  [Network Change Events](#sec-NCE) to integrate the incidents into the simulation.

### Scenarios {#sec-scenarios}

In the [Incident Data and Sampling](#sec-inc_data) section and @fig-incident_sampling_plot, we observe the establishment and categorization of twenty distinct incident seeds into either Current or Increased Incident frequencies. Each seed gave rise to three separate simulation groups. The first group, Incident, exclusively features scenarios with incidents occurring without any intervention from IMT. In the second group, includes incidents and the deployment of 20 IMT, while the third group features incidents managed with 30 IMT. To facilitate efficient organization and comparative analysis, each scenario was assigned a unique identifier, such as "1-10-257." Within this coding system, the first digit specifies the simulation group (Incident, 20 IMT, or 30 IMT), the second digit denotes the number of incidents included in the simulation, and the third digit corresponds to the seed value utilized for random incident selection.

In total, six scenario groups were established, as follows:

-   No IMT, current incident frequency
-   No IMT, increased incident frequency
-   20 IMT, current incident frequency
-   20 IMT, increased incident frequency
-   30 IMT, current incident frequency
-   30 IMT, increased incident frequency

It is important to note, as described in the IMT Setup, that not all IMT vehicles are operational simultaneously. Due to scheduling constraints, the actual number of vehicles on the road at any given time is typically half of the total fleet size.

The study utilizes the MATSim model for conducting simulations across all three groups: Incidents, 20-IMT, and 30-IMT. Each scenario underwent an internal comparison, as well as comparison against a Baseline scenario devoid of incidents or IMT intervention. This comprehensive analysis affords a holistic insight into the IMT effects on traffic dynamics and their operational efficiency.

The primary metric for traffic impact analysis in this study is the total vehicle hours of delay (VHD), dissected through three investigative tiers: Network Links, Motorway Links, and Impacted Links. Network Links offer a macroscopic view of the network-wide delay, Motorway Links focused on major highways and freeways, and Impacted Links provide a microscopic view of the delays at incident sites and their immediate upstream links. This tiered approach ensures a thorough analysis, capturing the overarching impact on traffic flow while also honing in on critical areas affected by incidents. The comparative analysis across different groups and tiers highlights the general impacts of IMT and their efficacy, particularly at the Impact Link level.

In addition to VHD, the study investigates the performance and operational efficiency of IMT. Metrics such as average travel times, distances, and incident response times of IMT are compared across scenarios. The 20-IMT group reflects the current fleet of IMT, while the 30-IMT group introduces an additional 10 vehicle, providing a basis for comparison to discern the impact of fleet size on operational efficiency. The analysis encompasses both the time and distance traveled by IMT trucks to incidents, offering insights into how effectively these resources are deployed and utilized.

By comparing the performance metrics of IMT trucks across different scenarios, we gain a better understanding of how fleet size influences operational efficiency. This, in turn, informs strategic decisions regarding resource allocation and deployment, ensuring that IMT vehicles are optimally utilized to mitigate traffic delays and enhance roadway safety.