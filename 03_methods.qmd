# Methodology {#sec-methods}

```{r setup, file = "R/chapter_start.R", include = FALSE}
# a number of commands need to run at the beginning of each chapter. This
# includes loading libraries that I always use, as well as options for 
# displaying numbers and text.
```

```{r setup2, include = FALSE}
# Other packages ------
# These are packages that get used in this chapter but aren't part of the default set.

library(ggplot2)
library(RColorBrewer)
library(kableExtra)
library(dplyr)
library(tidyr)
library(targets)
library(ggpattern)
library(extrafont)
library(scales)
```

As highlighted in the [literature review](#sec-literature), there is substantial evidence indicating that IMT can effectively reduce RCT and EUC following traffic incidents. Additionally, the effectiveness of DTA models in analyzing the impact of such incidents has been well-documented. However, there is a lack of comprehensive research evaluating IMT impact on entire traffic networks and their associated agents. To address this gap, it is necessary that we develop a model capable of simulating both traffic incidents and the ensuing IMT interventions, with the objective of gauging the efficiency of IMT deployments. Due to its proficiency in regional-scale incident simulation and its authentic portrayal of driver behavior, MATSim has been identified as the most suitable model for this research. This section describes the methodology, expounding on the model's capabilities, the requisite data inputs, and the benchmarks established for determining IMT effectiveness.

Our methodology is structured around three main components: the functionality of the MATSim model, the setup of IMT vehicles and incidents, and the scenarios for comparative analysis. In the [model design](#sec-MATSim_mod) subsection we describe the structure of the model and the functions it uses to represent incidents and IMT response. In [model implementation](#sec-model_imp) subsection we outline the data structure of the model by describing the [setup of IMT](#sec-IMT_setup) and explaining our [incident data and sampling](#sec-inc_data) methods. We conclude by describing the [scenarios](#sec-scenarios) we used for evaluating the impact of incidents and IMT.

## Model Design {#sec-MATSim_mod}

MATSim is an open-source framework used for conducting extensive, agent-based transportation simulations on a large scale. Operating as a dynamic traffic simulation, it is often used in demand modeling and agent-based mobility analysis [@dobler2012]. Thanks to its open-source architecture, MATSim enables the seamless integration of a diverse array of modules and packages into its models. Users across the platform can create, import, and modify these components, fostering a collaborative and innovative environment.

For the purposes of our research, we developed the ImtModule, a specialized MATSim extension designed to process incidents and IMT responses within the simulation. This module leverages existing research on incident simulation, Demand Rapid Transit (DRT), event handling, and vehicle dispatch algorithms, building upon these foundations to enhance the functionality of our model.

In this section, we describe some of the specific tools within MATSim that we used and adapted to construct a comprehensive and functional model. These tools include [scoring and replanning](#sec-MATSim_score), [network change events](#sec-NCE), and [IMT assignment](#sec-imt_response). Together, they contribute to the authenticity and precision of our traffic simulations, particularly in the context of responding to roadway incidents, ensuring that our model provides accurate and reliable results.

### Scoring and Replanning {#sec-MATSim_Score}

In MATSim, each individual within the simulation is called an agent. These agents follow daily schedules, partaking in various activities and modes of travel. Their actions are evaluated using a point system, which takes into account the specifics of their travel, as highlighted by @nagel2016. Timely arrivals at destinations are rewarded with positive points, whereas delays result in deductions. Furthermore, different transportation modes are assigned utility scores, which play a crucial role in shaping the agents' travel preferences and decisions.

Each agent possesses a memory that stores plans from a certain number of iterations, as well as replanning strategies that dictate how agents can adjust their plans from iteration to iteration [@horni2016]. The size of an agent's memory is typically dependent on the size of the model being run. In the case of our large-scale Utah model, we opted to limit the agents' plan memory to just five iterations. The replanning strategies used include selecting the plan with the highest score 80% of the time, opting to reroute 10% of the time, and adjusting activity timings for the remaining 10%. Our selection for the remaining scoring and replanning parameters drew from the incident research conducted by @kaddoura2018.

As will be detailed in the [model implementation](#sec-model_imp) subsection, the plans file used to generate simulations in MATSim was exceptionally large, encompassing travel data for over 2 million agents. Our objective, utilizing the complete plans file, was to guide the simulated agents toward an equilibrium in travel behavior. To achieve this, we employed the following methodology:

1.  We processed both the network and plans files over the course of 350 simulated iterations without any incidents or IMT included.
2.  Using the output from this preliminary scenario, we established a 'hot start' for the subsequent scenarios incorporating incidents and IMT responses. At this stage, a significant portion of agents had already identified efficient travel routes to their destinations. This preliminary phase of running the plans file was intended to expedite the convergence towards a balanced state in travel behavior for scenarios that included incidents and IMT responses.
3.  To achieve equilibrium in travel behavior, we conducted an additional 100 iterations in the simulations that accounted for incidents and IMT responses, ensuring a more comprehensive stabilization across the majority of scenarios.

@fig-score-output presents a MATSim scoring output from a scenario incorporating incidents and IMT responses. The figure indicates notable plan adjustments and corresponding score changes during the first 60 iterations. As the simulation progressed, the executed scores started to stabilize. To minimize the potential for significant variance, replanning was disabled after the 85th iteration. This approach ensures that the final iterations, which are critical for scenario analysis, reflect a steady state.

![MATSim scoring statistics output example.](figures/scorestats.png){#fig-score-output}

### Network Change Events {#sec-NCE}

Within a MATSim network, each link is characterized by specific attributes such as type, length, number of lanes, free-flow speed, and capacity. To effectively simulate unexpected events and their subsequent impacts on traffic flow, it is essential to dynamically adjust these attributes. This capability, termed a Time-Dependent Network, is explained in the MATSim textbook [@rieser2016] and is vital for ensuring the realism and accuracy of our simulation.

Network Change Events (NCE) serve as the mechanism within MATSim for modifying network attributes at precise moments during a simulation. Detailed in Section 6.1 of the MATSim textbook [@rieser2016], the implementation of NCE requires specific adjustments to the MATSim configuration file to facilitate a time-variant network. These events can modify a link's free-flow speed, number of lanes, or capacity. To initiate a NCE, the system requires specific information including the time of the event `startTime`, the affected link(s) `link refID`, the type of change `free-flow speed`, `lanes`, or `capacity`, and the value of the change. NCE are the tools used in this study to demonstrate the impact of both incidents and IMT arrivals.

### IMT Assignment and Response {#sec-imt_response}

Within MATSim, the deployment of one or more IMT is triggered by the occurrence of an incident. The optimal IMT for the situation is determined using a least-cost path algorithm, which calculates the quickest route based on real-time traffic conditions like congestion and link speeds. The IMT that can reach the incident location the fastest, accounting for current roadway speeds and congestion, is then dispatched. If all IMT are occupied at the time of an incident, the algorithm waits until an IMT becomes available and then dispatches it to the site of the incident.

When an IMT arrives at an incident within MATSim, a NCE is activated by an event handler, a MATSim tool that logs simulation events as they occur. This NCE demonstrates the IMT's impact by restoring 25% of the link's capacity that was reduced due to the incident. The arrival of each additional IMT unit contributes another 25% to the link's capacity. This approach to capacity adjustment is based on our incident database, which primarily includes incidents where IMT were deployed; in contrast, data on incidents without IMT response was limited. Therefore, the model assumes that IMT involvement leads to capacity improvement, rather than estimating RCT in the absence of IMT intervention. After consultation with UDOT and UHP, we determined that a 25% capacity restoration by each IMT unit is a reasonable estimate for our study, despite the lack of detailed research on the specific effects of IMT on roadway capacity restoration.

@fig-imt-capacity-restore illustrates the impact of traffic incidents on road capacity within the model, emphasizing the role of IMT in mitigating this impact. The figure presents a scenario where an incident causes a reduction in a road link's capacity to 20% for a duration of 60 minutes. Without any IMT intervention, this diminished capacity level would persist for the entire incident. However, the scenario changes with IMT involvement. The arrival of the first IMT 15 minutes after the incident boosts the link's capacity by 20%, raising it to 40%. If a second IMT team arrives 30 minutes after the incident begins, it provides an additional increase of 15%, enhancing the link's operating capacity to 55% for the duration of the incident. Full capacity is restored after the incident concludes. This visualization demonstrates the role of IMT in  restoring capacity after incidents and maintaining more efficient traffic flow during such events.

```{r incident_capacity_restore}
#| label: fig-imt-capacity-restore
#| fig-cap: IMT capacity restoration upon arrival example.
# Load the capacity data points
tar_load(imt_capacity_data)

# Define the new color palette
color_palette <- brewer.pal(n = 3, name = "Set2")

# Create the plot
capacity_plot <- ggplot(imt_capacity_data, aes(x = time, y = capacity, 
                                               color = group, linetype = group)) +
  geom_line() +
  geom_point(size = 3) +
  labs(x = "Time (mins)", y = "Link Capacity Percent (%)") +
  scale_x_continuous(breaks = seq(0, 120, 30)) +
  scale_y_continuous(breaks = seq(0, 100, 25)) +
  scale_color_manual(values = color_palette) +
  scale_linetype_manual(values = c("No IMT Response" = "solid", 
                                   "First IMT Response" = "dashed", 
                                   "Second IMT Response" = "dashed")) +
  theme_minimal(base_family = "TeX Gyre Pagella", base_size = 11) +
  theme(legend.position = "top", legend.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed", "dashed"))))

capacity_plot
```

## Model Implementation in Utah {#sec-model_imp}

To run the MATSim model with the ImtModule extension, a number of input resources are necessary. For the model to function properly, the following are needed:

-   A plans file detailing the agents to be modeled, as well as their activity.
-   A network file with interconnected links, enabling travel for the agents specified in the plans file.
-   A configuration file outlining the scoring metrics of the simulation and establishing parameters pertaining to agent and IMT travel patterns.
-   An IMT file outlining the IMT starting locations and hours of operation.
-   An incidents file containing the necessary data to randomly effect NCE throughout the simulation.

The network and plans files used in this research were developed and calibrated by @macfarlane2023 and @day2023 as part of their research projects studying accessibility and ride-hailing throughout the Wasatch Front. The configuration file used in the model was adapted from the @kaddoura2018 file, which was used for their MATSim incident analysis study. It was slightly modified to accommodate the IMT development, but the parameters they set were largely left unaltered. The IMT file was produced using data provided by UDOT and UHP, as outline in the [IMT setup](#sec-MATSim_mod) subsection. The incident data was compiled by @schultz2023 in his research of IMT performance measures and is explained in the [incident data and sampling](#sec-inc_data) subsection.

### IMT Setup {#sec-IMT_setup}

The data provided by UHP details the operations of IMT in the Wasatch Front for June 6th, 2023, representing their typical weekday activities. This schedule highlights the working hours and coverage of a fleet comprising 20 IMT units, spread across three zones: Davis, Salt Lake, and Utah counties. In this distribution, Salt Lake County is assigned 10 IMT units, while Davis and Utah counties receive 5 each. We will refer to this 20-unit configuration as the existing or current fleet in our simulations. To explore the impact of an expansion, we propose a scenario with an additional 10 IMT units, creating a 30-unit fleet termed the new or increased IMT fleet. These extra units are strategically placed within each county to ensure even coverage. @fig-IMT-Map visually represents the county boundaries and the initial positions of both the existing and proposed new IMT vehicles in our simulation.

![IMT starting locations example map.](figures/imt_gray_map.png){#fig-IMT-Map}

@fig-IMT-Map uses circles to mark the locations of existing IMT vehicles and stars for the proposed additions. We positioned these units strategically along major highways to achieve a balanced distribution of IMTs across each county. While this initial setup doesn't mirror the real-world scenario where drivers begin their shifts from home, it serves as a practical model for our simulations. The frequency of IMT operations on major highways like I-15, I-80, and I-215, along with the variable real-world starting points, justifies this strategic alignment along key routes. Typically, IMT vehicles do not cross county borders as dispatch services are organized by county. However, in our MATSim network, vehicles can cross into other counties depending on incident proximity. IMTs follow specific operational shifts, which we've programmed into MATSim to reflect their availability. In Utah, these often include a morning shift starting at 6:00 AM and an evening shift ending at 10:30 PM. @fig-IMT-Map also illustrates the IMT distribution during the evening shift, but it's important to note that this pattern is generally consistent during the morning shift as well.

Our research primarily concentrates on evaluating the potential impacts of expanding the IMT fleet, rather than examining the effects of their starting positions. We hypothesize that increasing the number of IMTs, assuming uniform distribution, will enhance their overall effectiveness.

### Incident Data and Sampling {#sec-inc_data}

In their concurrent IMT research, @schultz2023 developed a comprehensive dataset of incidents requiring management intervention, derived from data provided by UHP. Analyzing data from 2018 to 2022, they identified 1,604 incidents over 184 days that required the assistance of either IMT or UPH. This dataset is useful in understanding the frequency of daily incidents in the Wasatch Front that necessitate incident management intervention. @fig-incident-distribution-plot illustrates the number inicdnet in a given day on the x-axis and the number of days with that incident frequency on its y-axis.


@fig-incident-sampling-plot demonstrates the "Original Distribution" of observed daily incident frequencies in a bar chart format. To simulate this distribution in our model, we used a randomized sampling method to generate 10 distinct daily incident frequencies based on the original data, labeled as the "Current Frequency" group. These frequencies are represented as bars layered on top of the Original Distribution in @fig-incident-sampling-plot. Additionally, to assess IMT performance in scenarios with increased incident numbers, we created a "Increased Frequency" group. This group includes the 10 highest daily incident frequencies from the original data and is similarly layered over the "Original Distribution" in the @fig-incident-sampling-plot bar chart.

```{r incident_sampling_plot, fig.width=33, fig.height=18.6}
#| label: fig-incident-sampling-plot
#| fig-cap: Sampling distributions for incident frequencies.
# Load the incident sampling data
tar_load(incident_sampling_data)

# Update the category names
incident_sampling_data$category <- gsub("Current Frequency", 
                                        "Sample of Distribution", 
                                        incident_sampling_data$category)
incident_sampling_data$category <- gsub("Increased Frequency", 
                                        "Max Values of Distribution", 
                                        incident_sampling_data$category)

# Order the factor levels for the 'category' column to control the legend order
incident_sampling_data$category <- factor(incident_sampling_data$category, 
                                          levels = c("Incident Distribution", 
                                                     "Sample of Distribution", 
                                                     "Max Values of Distribution"))

# Define a new color palette with three colors
color_palette <- brewer.pal(n = 3, name = "Set2")

# Create the plot
incident_sampling_plot <- ggplot() +
  # Add bars for the 'Incident Distribution' category
  geom_bar(data = subset(incident_sampling_data, category == "Incident Distribution"), 
           aes(x = as.factor(Total_Count), fill = category), 
           position = "dodge", stat = "count", width = 0.8) +
  
  # Overlay bars for the 'Sample of Incident Distribution' category
  geom_bar(data = subset(incident_sampling_data, category == "Sample of Distribution"), 
           aes(x = as.factor(Total_Count), fill = category), 
           stat = "count", width = 0.8, color = NA) + # Removed border for these bars
  
  # Add border color for the 'Max Values of Incident Distribution' category
  geom_bar(data = subset(incident_sampling_data, category == "Max Values of Distribution"), 
           aes(x = as.factor(Total_Count), fill = category), 
           position = "dodge", stat = "count", width = 0.8,
           color = color_palette[3], linewidth = 8) +
  
    # Set the colors for the fill
  scale_fill_manual(values = setNames(c(color_palette[1], color_palette[2], color_palette[1]), 
                                      c("Incident Distribution", 
                                        "Sample of Distribution", 
                                        "Max Values of Distribution")),
                              limits = c("Incident Distribution", 
                                         "Sample of Distribution", 
                                         "Max Values of Distribution")) +

  # Add labels and theme
  labs(x = 'Number of Incidents in a Given Day', y = 'Number of Days') +
  theme_minimal(base_family = "TeX Gyre Pagella", base_size = 40) +
  theme(legend.title = element_blank(),
        legend.position = c(0.95, 0.95),
        legend.justification = c("right", "top"),
        legend.margin = margin(-10, -10, -10, -10),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.key.size = unit(3.5, "cm"),
        legend.text = element_text(size = 46), # Increased legend text size

        text = element_text(size = 11),
        
        axis.title = element_text(size = 65), # Increase the axis title font size
        axis.text = element_text(size = 55), # Increase the axis text font size

        plot.margin = margin(b = 20)) +

  guides(fill = guide_legend(override.aes = list(colour = c(NA, NA, color_palette[3]), 
                                                  linetype = c("blank", "blank", "solid"), 
                                                  size = c(0.5, 0.5, 8))))
# Print the plot
incident_sampling_plot
```

From their established dataset of 1604 incidents @schultz2023 filtered the data to ensure the completeness of each incident record in the dataset, ensuring that the incident was responded to by and IMT and contained complete information on incident duration, capacity reduction and location, all of which are necessary for a comprehensive evaluation. Filtering with those requirements they reduced the list to 411 unique incidents that received IMT assistance. 


@schultz2023 undertook concurrent IMT research and compiled a comprehensive dataset of incidents requiring IMT intervention, drawing on data from the UHP. They carefully ensured the completeness of each incident record in the dataset, capturing crucial details such as the incident start and end times, RCT, location, and extent of capacity reduction.

Analyzing data from 2018 and 2022, @schultz2023 successfully identified 1604 incidents over 184 days that required either IMT or UPH  assistance. The dataset they compiled provides insights into the frequency of daily incidents in the Wasatch Front that are responded to by incident management resources and is displayed in @fig-incident-sampling-plot with the label "Original Distribution". To represent that distribution of daily incidents in our model, we used a randomized sampling technique to generate 10 distinct values representing daily incident frequencies base on the "Original Distribution" of the number of incidents in a given day. Those 10 values will be refereed to as the "Current Incident Frequency" or "Current Frequency" group and overlay the Original Distribution values in @fig-incident-sampling-plot. Additionally, with the desire to see how IMT would preform with an elevated number of incidents we formed a second sampling group called the "Increased Incident Frequency" group, that was comprised of the 10 largest daily incident frequencies from the original incident distribution. 


From the list of 1604 incident they identified 411 unique incidents that received IMT assistance and contained essential information on duration, capacity reduction and location, all of which are necessary for a comprehensive evaluation. We used this carefully curated dataset to selectively include specific incidents in the MATSim model. 

From that list of incidents they identified 411 unique incidents with varying degrees of severity, ranging from property damage to fatal incidents. We used this carefully curated dataset to selectively include specific incidents in the MATSim model. It is important to acknowledge that these 411 incidents only constitute a portion of all incidents reported by UHP during this time frame. A number of additional incidents were excluded from the analysis because they lacked essential information on duration, capacity reduction, or location, all of which are necessary for a comprehensive evaluation. Nevertheless, the integration of the 411 analyzed incidents with the additional incomplete records provides insights, aiding in quantifying the total number of incidents within a specific time period. These combined incident records informed the modeling of daily incident frequencies but were not used for incident sampling in the simulation

To generate 10 distinct values representing daily incident frequencies, we employed a randomized sampling technique. These values were collectively termed Current Incident Frequencies as they were derived from the original distribution of daily incidents. Furthermore, we formulated a second set of 10 additional daily incident values, named Increased Incident Frequencies. These values were extracted from the upper portion of the 2022 incident data and were specifically designed to assess the resilience and efficacy of the IMT system under scenarios of markedly increased daily incidents. The visual depiction of the original distribution of daily incidents, alongside the distributions for both the Current and Increased Incident Frequencies, is illustrated in @fig-incident-sampling-plot.

In total, 20 values were selected, evenly split with 10 allocated to the Current Incident Frequency category, and the remaining 10 to the Increased Incident Frequency category. Each value was subsequently paired with a unique three-digit seed number, used internally within MATSim to ensure a randomized selection of incidents for each simulation scenario. Following this, we employed MATSim [Network Change Events](#sec-NCE) to integrate the incidents into the simulation.

### Scenarios {#sec-scenarios}

In the [incident sampling](#sec-inc_data) section and @fig-incident-sampling-plot, we observe the establishment and categorization of 20 distinct incident seeds into either Current or Increased Incident frequencies. Each seed gave rise to three separate simulation groups. The first group, No IMT, exclusively features simulations where incidents occur without any IMT intervention. The second group includes incidents and the deployment of 20 IMT, while the third group features incidents managed by 30 IMT.

In total, six scenario groups, each containing 10 random "days" with distinct incident sets, were established, as follows:

-   No IMT, current incident frequency
-   No IMT, increased incident frequency
-   20 IMT, current incident frequency
-   20 IMT, increased incident frequency
-   30 IMT, current incident frequency
-   30 IMT, increased incident frequency

It is important to note, as described in the [IMT setup](#sec-IMT_setup) section, that not all IMT vehicles are operational simultaneously. Due to scheduling constraints, the actual number of IMT on the road at any given time is typically half of the total fleet size.

Scenarios are evaluated by comparing each group with a baseline scenario that assumes no incidents or IMT interventions. In this study, the primary metrics for analyzing the traffic impact of incidents and IMT are the vehicle hours of delay (VHD) and RT. The MATSim outputs for each scenario include the average delay per link over 15-minute periods. Additionally, we compiled a file for each scenario documenting the traffic volumes for each link during these time intervals. Multiplying the traffic volumes by the average delays yields a detailed delay file, which represents the aggregate delay on each network link for the simulated "day". The formula for calculating the link-specific delay in a scenario is provided in @eq-vhd_group.

$$
\text{VHD per link} = {\sum_{i=1}^{n} a_i}*{v_i}
$$ {#eq-vhd_group} In @eq-vhd_group, $a_i$ denotes the average delay for a link in the $i^{th}$ time bin, while $v_i$ corresponds to the volume of vehicles traversing that link during the same interval. The VHD for all links is summed to calculate the total VHD for the entire network, and this total is further categorized by motorway links and links directly affected by incidents. For comparative analysis, the average VHD is computed across all scenarios within each group. The analysis divides the average VHD into three distinct categories: Network Links, Motorway Links, and Impacted Links. Network Links provide a macroscopic view of network-wide delays, Motorway Links focus on key routes such as highways and freeways, and Impacted Links offer a detailed analysis of the delays at incident sites and their immediate surroundings. This multi-tiered approach to analysis facilitates a comprehensive evaluation of the widespread and specific traffic impacts of incidents.

In addition to VHD, the study investigates the performance and operational efficiency of IMT. Metrics such as the average travel times, travel distances, and incident RT are compared across the 20 IMT and 30 IMT groups. This, in turn, informs strategic decisions regarding resource allocation and deployment, ensuring that IMT vehicles are optimally used to mitigate traffic delays and enhance roadway safety.
